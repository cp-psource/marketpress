<?php
/**
 * MarketPress Erlaube Bewertungen Addon
 */
/**
 * MarketPress Erlaube Bewertungen Addon
 */
class MP_Comments_Addon {
    /**
     * Pfad zum Addon-Verzeichnis
     *
     * @var string
     */
    public $plugin_dir;

    /**
     * URL zum Addon-Verzeichnis
     *
     * @var string
     */
    public $plugin_url;
    
    /**
     * Refers to a single instance of the class
     *
     * @since 3.0
     * @access private
     * @var object
     */
    private static $_instance = null;
    
    /**
     * Gets the single instance of the class
     *
     * @since 3.0
     * @access public
     * @return object
     */
    public static function get_instance() {
        if (is_null(self::$_instance)) {
            self::$_instance = new MP_Comments_Addon();
        }
        return self::$_instance;
    }

    /**
     * Konstruktor
     * @access private
     */
    private function __construct() {
        $this->plugin_dir = plugin_dir_path(__FILE__);
        $this->plugin_url = plugin_dir_url(__FILE__);

        // Konstanten definieren für die Abwärtskompatibilität
        if (!defined('MP_COMMENTS_PLUGIN_DIR')) {
            define('MP_COMMENTS_PLUGIN_DIR', $this->plugin_dir);
        }
        if (!defined('MP_COMMENTS_PLUGIN_URL')) {
            define('MP_COMMENTS_PLUGIN_URL', $this->plugin_url);
        }

        // Erforderliche Dateien einbinden
        require_once $this->plugin_dir . 'templates/comment-template.php';
        require_once $this->plugin_dir . 'includes/functions.php';

        // Admin-Dateien einbinden, wenn im Admin-Bereich
        if (is_admin()) {
            require_once $this->plugin_dir . 'admin/settings.php';
        }
        
        // Hooks initialisieren
        add_action('init', array($this, 'init'), 20);
    }
    
    /**
     * Initialisiere die Addon-Funktionalität
     */
    public function init() {
        // Überprüfen, ob wir die Einstellungsseite anzeigen sollen
        if (mp_get_get_value('addon', null) == 'MP_Comments_Addon') {
            $this->view_settings();
        }
        
        // Hooks für die Integration der Produktbewertungen initialisieren
        $this->init_hooks();
    }
    
    /**
     * Einstellungsansicht für das Addon
     */
    public function view_settings() {
        // Die Einstellungen werden durch die settings.php-Datei gehandhabt
    }
    
    /**
     * Deaktiviere Addon
     */
    public function deactivate() {
        // Bereinigungsaktionen bei der Deaktivierung ausführen
        flush_rewrite_rules();
    }
    
    /**
     * Initialisiere Hooks
     */
    private function init_hooks() {

        // Kommentarunterstützung für Produkte aktivieren
        add_action('init', array($this, 'enable_product_comments'));
        
        // Prüfen, ob eine Bewertung abgegeben wurde
        add_filter('preprocess_comment', array($this, 'verify_comment_rating'));
        
        // Bewertung speichern
        add_action('comment_post', array($this, 'save_comment_rating'), 10, 3);
        
        // Kommentarformular in die Produktseite einfügen
        add_action('mp_product_description_end', array($this, 'display_comments_template'), 20);
        add_action('mp_single_product_end', array($this, 'display_comments_template'), 20);
        
        // Sicherstellen, dass Kommentare für Produkte aktiviert sind
        add_filter('comments_open', array($this, 'enable_comments_for_products'), 10, 2);
    }
    
    /**
     * Aktiviere Kommentarunterstützung für Produkte
     */
    public function enable_product_comments() {
        add_post_type_support('product', 'comments');
    }
    
    /**
     * Prüfe, ob eine Bewertung abgegeben wurde
     */
    public function verify_comment_rating($commentdata) {
        // Nur für Produkte prüfen
        if (get_post_type($commentdata['comment_post_ID']) === 'product') {
            // Wenn keine Bewertung abgegeben wurde und es kein Admin ist
            if (!isset($_POST['rating']) || empty($_POST['rating'])) {
                // Fehler ausgeben und Script beenden
                wp_die(__('Fehler: Bitte wähle eine Bewertung aus.', 'mp'), __('Bewertung fehlt', 'mp'), array('back_link' => true));
            }
        }
        return $commentdata;
    }
    
    /**
     * Bewertung speichern
     */
    public function save_comment_rating($comment_id, $comment_approved, $commentdata) {
        if (isset($_POST['rating']) && get_post_type($commentdata['comment_post_ID']) === 'product') {
            $rating = intval($_POST['rating']);
            if ($rating >= 1 && $rating <= 5) {
                add_comment_meta($comment_id, 'rating', $rating, true);
            }
        }
    }
    
    /**
     * Kommentarformular in die Produktseite einfügen
     */
    public function display_comments_template() {
        global $post;
        if (get_post_type() === 'product') {
            // Unser eigenes Bewertungstemplate verwenden
            include_once $this->plugin_dir . 'templates/comments.php';
        }
    }
    
    /**
     * Sicherstellen, dass Kommentare für Produkte aktiviert sind
     */
    public function enable_comments_for_products($open, $post_id) {
        $post_type = get_post_type($post_id);
        if ($post_type === 'product') {
            return true;
        }
        return $open;
    }

    /**
     * Füge eine Bewertungsspalte zur Kommentar-Admin-Ansicht hinzu
     */
    public function add_comment_rating_column($columns) {
        $columns['rating'] = __('Bewertung', 'mp');
        return $columns;
    }

    /**
     * Fülle die Bewertungsspalte mit Daten
     */
    public function comment_rating_column_content($column, $comment_ID) {
        if ($column !== 'rating') return;
        
        $comment = get_comment($comment_ID);
        if (get_post_type($comment->comment_post_ID) !== 'product') return;
        
        $rating = get_comment_meta($comment_ID, 'rating', true);
        if ($rating) {
            echo str_repeat('★', $rating) . str_repeat('☆', 5 - $rating) . ' (' . $rating . '/5)';
        } else {
            echo '–';
        }
    }

    /**
     * Enqueue Frontend-Skripte für bessere Darstellung
     */
    public function enqueue_rating_scripts() {
        if (is_singular('product')) {
            // Inline-CSS für bessere Sternbewertung im Header
            wp_add_inline_style('mp-style', '
                .comment-rating {
                    display: flex;
                    align-items: center;
                    margin-bottom: 15px;
                    background: #f9f9f9;
                    padding: 10px;
                    border-radius: 5px;
                    font-weight: bold;
                }
                .rating-stars {
                    color: #FFD700;
                    font-size: 1.3em;
                    margin-right: 10px;
                }
                .rating-score {
                    margin-right: 5px;
                    font-weight: bold;
                }
                .rating-label {
                    color: #666;
                }
                .average-rating {
                    display: flex;
                    align-items: center;
                    margin: 20px 0;
                    padding: 15px;
                    background: #f5f5f5;
                    border-radius: 8px;
                    box-shadow: 0 2px 5px rgba(0,0,0,0.05);
                }
                .rating-count {
                    margin-left: 10px;
                    color: #666;
                }
            ');
        }
    }

    /**
     * Überschreibe das Standard-Kommentar-Template für Produktseiten
     */
    public function override_comments_template($template) {
        if (get_post_type() === 'product') {
            return $this->plugin_dir . 'templates/comments.php';
        }
        return $template;
    }

    /**
     * Lade Bewertungssystem-Assets und UI-Fixes
     */
    public function load_rating_assets() {
    // UI-Fixes für MarketPress-Produkte
    if (function_exists('mp_product') || is_singular('product') || is_post_type_archive('product') || is_tax('product_category') || is_tax('product_tag')) {
        // Inline CSS für globale MarketPress UI-Fixes
        wp_add_inline_style('mp-style', '
            /* Verhindere unerwünschte Cursor-Positionierung und Textauswahl */
            .mp_product_content, 
            .mp_product_price,
            .mp_product_meta,
            .mp_product_details,
            .mp_product_categories,
            .mp_product_tags,
            .mp-product {
                user-select: none;
            }
            
            /* Erlaube Textauswahl für wichtige Inhalte */
            .mp_product_content .entry-content,
            .mp_product_content .entry-summary,
            .mp_product_description {
                user-select: text;
            }
            
            /* Verbessere Input-Elemente und Links */
            .mp_product input, 
            .mp_product textarea,
            .mp_product select,
            .mp_product button,
            .mp_product a {
                user-select: text;
                outline: 2px solid transparent;
            }
        ');
        
        // Inline JavaScript für globale MarketPress UI-Fixes
        wp_add_inline_script('mp-global', '
            jQuery(document).ready(function($) {
                // Verhindere Cursor-Probleme in MarketPress-Elementen
                $("body").on("mousedown", ".mp_product_content, .mp_product_price, .mp_product_meta, .mp_product_details, .mp-product", function(e) {
                    if (!$(e.target).is("input, textarea, select, button, a") && 
                        !$(e.target).closest(".mp_product_description").length) {
                        e.preventDefault();
                    }
                });
            });
        ', 'after');
    }
    
    // Bewertungssystem-Assets nur auf Produktseiten laden
    if (is_singular('product')) {
        wp_enqueue_style('mp-ratings-style', MP_COMMENTS_PLUGIN_URL . 'assets/css/ratings.css', array(), '1.0.0');
        wp_enqueue_script('mp-ratings-script', MP_COMMENTS_PLUGIN_URL . 'assets/js/ratings.js', array('jquery'), '1.0.0', true);
        
        // Lokalisierung für JavaScript
        wp_localize_script('mp-ratings-script', 'mp_ratings_i18n', array(
            'rating_1' => __('Schlecht (1 Stern)', 'mp'),
            'rating_2' => __('Ausreichend (2 Sterne)', 'mp'),
            'rating_3' => __('Gut (3 Sterne)', 'mp'),
            'rating_4' => __('Sehr gut (4 Sterne)', 'mp'),
            'rating_5' => __('Ausgezeichnet (5 Sterne)', 'mp'),
            'select_rating' => __('Bitte wähle eine Bewertung aus.', 'mp'),
        ));
        
        // Lokalisierung für das Bearbeitungsformular
        wp_localize_script('mp-edit-rating', 'mp_edit_rating', array(
            'ajaxurl' => admin_url('admin-ajax.php'),
            'rating_label' => __('Deine Sternebewertung', 'mp'),
            'rating_text' => array(
                1 => __('Schlecht (1 Stern)', 'mp'),
                2 => __('Ausreichend (2 Sterne)', 'mp'),
                3 => __('Gut (3 Sterne)', 'mp'),
                4 => __('Sehr gut (4 Sterne)', 'mp'),
                5 => __('Ausgezeichnet (5 Sterne)', 'mp')
            ),
            'rating_label_1' => __('Schlecht', 'mp'),
            'rating_label_2' => __('Ausreichend', 'mp'),
            'rating_label_3' => __('Gut', 'mp'),
            'rating_label_4' => __('Sehr gut', 'mp'),
            'rating_label_5' => __('Ausgezeichnet', 'mp'),
            'save_button' => __('Bewertung speichern', 'mp'),
            'cancel_button' => __('Abbrechen', 'mp'),
            'saving' => __('Wird gespeichert...', 'mp'),
            'error_message' => __('Ein Fehler ist aufgetreten. Bitte versuche es erneut.', 'mp')
        ));
    }
}

/**
 * Hilfsfunktion für den Zugriff auf die Addon-Instanz
 *
 * @since 3.0
 * @access public
 * @return MP_Comments_Addon
 */
function mp_comments() {
    return MP_Comments_Addon::get_instance();
}

// Initialisieren des Addons
mp_comments();


